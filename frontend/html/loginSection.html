<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login Selection</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    :root {
      --clr-light: #f5f7fa;
      --clr-primary: #131315;
      --clr-white: #ffffff;
      --clr-dark: #222222;
      --clr-color-dark: #2e2e2e;
      --clr-color-background: #f0f2f5;
      --clr-black-variant: #555555;
      --clr-info-dark: #7d8da1;
      --clr-success: #1abc9c;
      --clr-danger: #e74c3c;
      --clr-warning: #f39c12;
      --card-padding: 0.8rem;
      --card-border-radius: 12px;
      --card-box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(22, 33, 62, 0.9) 50%, rgba(15, 52, 96, 0.9) 100%),
                  url('../../image/login-background.jpeg') center/cover no-repeat fixed;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(26, 188, 156, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(52, 152, 219, 0.15) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: "";
      position: fixed;
      bottom: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(19, 19, 21, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(30px, -30px); }
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(19, 19, 21, 0.7);
      backdrop-filter: blur(10px);
      color: var(--clr-white);
      padding: 1.2rem 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 100;
    }

    .left-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .logo:hover {
      border-color: var(--clr-success);
      transform: scale(1.05);
    }

    .system-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--clr-white);
      letter-spacing: 1px;
    }

    .login-btn {
      background: linear-gradient(135deg, var(--clr-primary) 0%, var(--clr-color-dark) 100%);
      color: var(--clr-white);
      border: none;
      padding: 0.7rem 1.8rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(19, 19, 21, 0.3);
      position: relative;
      z-index: 2;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(19, 19, 21, 0.4);
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
      overflow-y: auto;
    }

    .modal.show {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(135deg, var(--clr-white) 0%, #f8f9fa 100%);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 3rem 2.5rem;
      width: 100%;
      max-width: 450px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      animation: slideUp 0.4s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin: auto;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-content h2 {
      color: var(--clr-primary);
      font-size: 1.8rem;
      font-weight: 700;
      text-align: left;
      margin-bottom: 2rem;
      position: relative;
      padding-bottom: 1rem;
    }

    .modal-content h2::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 4px;
      background: linear-gradient(90deg, var(--clr-primary) 0%, var(--clr-success) 100%);
      border-radius: 2px;
    }

    .close {
      position: absolute;
      right: 1.5rem;
      top: 1.5rem;
      font-size: 1.8rem;
      color: var(--clr-info-dark);
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }

    .close:hover {
      color: var(--clr-danger);
      background: rgba(231, 76, 60, 0.1);
      transform: scale(1.1);
    }

    .role-buttons {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      margin-top: 0.5rem;
    }

    .role-btn {
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 12px;
      color: var(--clr-white);
      background: linear-gradient(135deg, var(--clr-primary) 0%, var(--clr-color-dark) 100%);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(19, 19, 21, 0.2);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
    }

    .role-btn:hover {
      background: linear-gradient(135deg, var(--clr-color-dark) 0%, var(--clr-primary) 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(19, 19, 21, 0.3);
    }

    .role-btn span {
      font-size: 1.2rem;
    }

    .login-form {
      display: none;
    }

    .login-form.show {
      display: block;
    }

    .role-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .role-header button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--clr-info-dark);
      transition: all 0.3s ease;
    }

    .role-header button:hover {
      color: var(--clr-primary);
      transform: scale(1.1);
    }

    .role-header h3 {
      color: var(--clr-primary);
      font-size: 1.2rem;
      margin: 0;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    input, select {
      padding: 0.9rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--clr-primary);
      box-shadow: 0 0 0 3px rgba(19, 19, 21, 0.1);
    }

    input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
      color: #999;
    }

    input[readonly] {
      background: #f5f5f5;
      cursor: not-allowed;
      color: var(--clr-primary);
    }

    .otp-row {
      display: flex;
      gap: 0.8rem;
    }

    .otp-row input {
      flex: 1;
    }

    button[type="submit"],
    button[type="button"] {
      padding: 0.9rem 1.5rem;
      background: linear-gradient(135deg, var(--clr-primary) 0%, var(--clr-color-dark) 100%);
      color: var(--clr-white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(19, 19, 21, 0.2);
    }

    button[type="submit"]:hover:not(:disabled),
    button[type="button"]:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(19, 19, 21, 0.3);
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .otp-row button[type="button"] {
      flex: 0 1 120px;
    }

    .error {
      color: var(--clr-danger);
      font-size: 0.9rem;
      text-align: center;
      margin: 0 !important;
    }

    .success {
      color: var(--clr-success);
      font-size: 0.9rem;
      text-align: center;
      margin: 0 !important;
    }

    .register-text {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--clr-black-variant);
    }

    .register-link {
      color: var(--clr-primary);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .register-link:hover {
      color: var(--clr-success);
      text-decoration: underline;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 600;
      color: var(--clr-primary);
      font-size: 0.95rem;
    }

    .form-group label .required {
      color: var(--clr-danger);
      margin-left: 0.2rem;
    }

    .form-group input {
      padding: 0.85rem 0.95rem;
      font-size: 0.95rem;
    }

    .form-group .feedback {
      font-size: 0.85rem;
      margin-top: 0.2rem;
      min-height: 1.2rem;
    }

    .form-group .feedback.error {
      color: var(--clr-danger);
    }

    .form-group .feedback.success {
      color: var(--clr-success);
    }

    /* Dynamic input visibility */
    .dynamic-input {
      display: none;
    }

    .dynamic-input.show {
      display: block;
    }

    @media (max-width: 600px) {
      .top-bar {
        padding: 1rem 1.5rem;
      }

      .system-name {
        font-size: 1.2rem;
      }

      .modal-content {
        width: 90%;
        padding: 2rem 1.5rem;
      }

      .modal-content h2 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .role-btn {
        padding: 0.9rem 1.2rem;
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <header class="top-bar">
    <div class="left-section">
      <img src="../../image/logo.png" alt="Logo" class="logo" />
      <h1 class="system-name">MITHER3</h1>
    </div>
    <button class="login-btn" id="loginBtn">Log In</button>
  </header>

  <div class="modal" id="loginModal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>

      <!-- Role Selection View -->
      <div id="roleSelection">
        <h2>Log in</h2>
        <div class="role-buttons">
          <button class="role-btn" data-role="admin">
            <span class="material-symbols-outlined">admin_panel_settings</span>
            Admin Log In
          </button>
          <button class="role-btn" data-role="user">
            <span class="material-symbols-outlined">person</span>
            Login as User
          </button>
        </div>
      </div>

      <!-- Admin Login Form -->
      <div id="adminForm" class="login-form">
        <div class="role-header">
          <button type="button" id="backBtn">‚Üê</button>
          <h3>Admin Login</h3>
        </div>
        <form id="loginFormAdmin">
          <input type="email" id="adminEmail" placeholder="Email" required>
          <input type="password" id="adminPassword" placeholder="Password" required>
          <div class="otp-row">
            <input type="text" id="adminOtp" placeholder="Enter OTP" disabled required>
            <button type="button" id="adminGetOtpBtn">Get OTP</button>
          </div>
          <button type="submit">Login</button>
        </form>
        <p id="adminError" class="error"></p>
        <p id="adminSuccess" class="success"></p>
      </div>

      <!-- Unified User Login Form (HR, Employee, Client) -->
      <div id="userForm" class="login-form">
        <div class="role-header">
          <button type="button" class="backBtn">‚Üê</button>
          <h3>User Login</h3>
        </div>
        <form id="loginFormUser">
          <!-- User Type Selector -->
          <select id="userTypeSelect" required>
            <option value="">Select User Type</option>
            <option value="hr">HR</option>
            <option value="employee">Employee</option>
            <option value="client">Client</option>
          </select>

          <input type="email" id="userEmail" placeholder="Email" required>
          
          <!-- Dynamic inputs based on user type -->
          <input type="text" id="hrIdNumber" class="dynamic-input" placeholder="HR ID Number" required>
          <input type="text" id="employeeBadgeNumber" class="dynamic-input" placeholder="SSS NR (00-0000000-0)" required maxlength="12">
          <input type="text" id="clientIdNumber" class="dynamic-input" placeholder="Client ID Number" required>
          
          <input type="password" id="userPassword" placeholder="Password" required>
          <div class="otp-row">
            <input type="text" id="userOtp" placeholder="Enter OTP" disabled required>
            <button type="button" id="userGetOtpBtn">Get OTP</button>
          </div>
          <button type="submit">Login</button>
        </form>
        <p id="userError" class="error"></p>
        <p id="userSuccess" class="success"></p>
        <p class="register-text" id="registerTextContainer" style="display:none;">
          No account? <span id="userRegisterLink" class="register-link">Register here</span>
        </p>
      </div>
    </div>
  </div>

  <!-- Employee Registration Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <span class="close" id="closeRegister">&times;</span>
      <h2>Employee Registration</h2>

      <form id="registerForm">
        <div class="form-group">
          <label for="badgeNo">SSS NR (00-0000000-0) <span class="required">*</span></label>
          <input 
            type="text" 
            id="badgeNo" 
            placeholder="Enter SSS NR (00-0000000-0)" 
            required 
            maxlength="12"
          >
          <div id="badgeNoFeedback" class="feedback"></div>
        </div>

        <div class="form-group">
          <label for="familyName">Family Name <span class="required">*</span></label>
          <input 
            type="text" 
            id="familyName" 
            placeholder="Family Name" 
            readonly
          >
        </div>

        <div class="form-group">
          <label for="firstName">First Name <span class="required">*</span></label>
          <input 
            type="text" 
            id="firstName" 
            placeholder="First Name" 
            readonly
          >
        </div>

        <div class="form-group">
          <label for="middleName">Middle Name</label>
          <input 
            type="text" 
            id="middleName" 
            placeholder="Middle Name" 
            readonly
          >
        </div>

        <div class="form-group">
          <label for="registerEmail">Email <span class="required">*</span></label>
          <input 
            type="email" 
            id="registerEmail" 
            placeholder="Email" 
            required
          >
        </div>

        <button type="submit" id="registerSubmitBtn" disabled>
          Register
        </button>
        <div id="registerFormFeedback" class="feedback"></div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal" id="changePasswordModal">
    <div class="modal-content">
      <h2>Change Password</h2>
      <form id="changePasswordForm">
        <input type="password" id="newPassword" placeholder="New Password" required />
        <input type="password" id="confirmPassword" placeholder="Confirm Password" required />
        <button type="submit">Update Password</button>
      </form>
      <p id="changePasswordError" class="error"></p>
    </div>
  </div>

  <!-- Client Registration Modal -->
  <div class="modal" id="clientRegisterModal">
    <div class="modal-content" style="max-width: 500px;">
      <span class="close" id="closeClientRegister">&times;</span>
      <h2>Register as a Client</h2>

      <form id="clientRegisterForm" enctype="multipart/form-data">
        <input type="text" id="clientName" placeholder="Name" required />
        <input type="email" id="clientEmail" placeholder="Email" required />
        <input type="password" id="clientPassword" placeholder="Password" required />
        <input type="password" id="clientPasswordConfirm" placeholder="Confirm Password" required />
        
        <select id="clientBranch" required>
          <option value="">Select a branch</option>
        </select>

        <label style="font-size: 0.9rem; color: var(--clr-info-dark); margin-top: 0.5rem; display: block;">
          Contract (PDF):
        </label>
        <input type="file" id="contractFile" accept=".pdf" required />

        <button type="submit">Submit Registration</button>
      </form>
      <p id="clientRegisterError" class="error"></p>
      <p id="clientRegisterSuccess" class="success"></p>
    </div>
  </div>

  <script>
    const API_URL = "https://www.mither3security.com/api/users";

    document.addEventListener("DOMContentLoaded", () => {
      const loginBtn = document.getElementById("loginBtn");
      const modal = document.getElementById("loginModal");
      const closeModal = document.getElementById("closeModal");
      const roleSelection = document.getElementById("roleSelection");
      const roleButtons = document.querySelectorAll(".role-btn");
      const backBtn = document.getElementById("backBtn");
      const backBtns = document.querySelectorAll(".backBtn");

      // User type selector elements
      const userTypeSelect = document.getElementById("userTypeSelect");
      const hrIdNumberInput = document.getElementById("hrIdNumber");
      const employeeBadgeNumberInput = document.getElementById("employeeBadgeNumber");
      const clientIdNumberInput = document.getElementById("clientIdNumber");
      const registerTextContainer = document.getElementById("registerTextContainer");

      // Open modal
      loginBtn.addEventListener("click", () => {
        modal.classList.add("show");
        showRoleSelection();
      });

      // Close modal
      closeModal.addEventListener("click", () => {
        modal.classList.remove("show");
      });

      window.addEventListener("click", (e) => {
        if (e.target === modal) modal.classList.remove("show");
      });

      // Show role selection
      function showRoleSelection() {
        document.querySelectorAll(".login-form").forEach(f => f.classList.remove("show"));
        roleSelection.style.display = "block";
      }

      // Show form for role
      function showForm(role) {
        roleSelection.style.display = "none";
        document.querySelectorAll(".login-form").forEach(f => f.classList.remove("show"));
        const formId = `${role}Form`;
        document.getElementById(formId).classList.add("show");
      }

      // Role button listeners
      roleButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const role = btn.dataset.role;
          showForm(role);
        });
      });

      // Back button listeners
      backBtn.addEventListener("click", showRoleSelection);
      backBtns.forEach(btn => {
        btn.addEventListener("click", showRoleSelection);
      });

      // Handle user type selection changes
      userTypeSelect.addEventListener("change", (e) => {
        const userType = e.target.value;
        
        // Hide all dynamic inputs
        hrIdNumberInput.classList.remove("show");
        employeeBadgeNumberInput.classList.remove("show");
        clientIdNumberInput.classList.remove("show");
        registerTextContainer.style.display = "none";
        
        // Remove required attribute from all
        hrIdNumberInput.removeAttribute("required");
        employeeBadgeNumberInput.removeAttribute("required");
        clientIdNumberInput.removeAttribute("required");
        
        // Show relevant input based on user type
        if (userType === "hr") {
          hrIdNumberInput.classList.add("show");
          hrIdNumberInput.setAttribute("required", "required");
        } else if (userType === "employee") {
          employeeBadgeNumberInput.classList.add("show");
          employeeBadgeNumberInput.setAttribute("required", "required");
          registerTextContainer.style.display = "block";
        } else if (userType === "client") {
          clientIdNumberInput.classList.add("show");
          clientIdNumberInput.setAttribute("required", "required");
          registerTextContainer.style.display = "block";
        }
      });

      // Badge number formatting for employee
      [employeeBadgeNumberInput, document.getElementById("badgeNo")].forEach(input => {
        if (input) {
          input.addEventListener("input", function() {
            this.value = this.value
              .replace(/[^0-9]/g, "")
              .replace(/(\d{2})(\d{1,7})(\d{0,1}).*/, function(_, p1, p2, p3) {
                return p3 ? `${p1}-${p2}-${p3}` : p2 ? `${p1}-${p2}` : p1;
              });
          });
        }
      });

      // ==================== ADMIN LOGIN ====================
      const adminForm = document.getElementById("loginFormAdmin");
      const adminGetOtpBtn = document.getElementById("adminGetOtpBtn");
      const adminOtpInput = document.getElementById("adminOtp");
      const adminEmailInput = document.getElementById("adminEmail");
      const adminPasswordInput = document.getElementById("adminPassword");
      const adminErrorP = document.getElementById("adminError");
      const adminSuccessP = document.getElementById("adminSuccess");

      adminGetOtpBtn.addEventListener("click", async () => {
        adminErrorP.textContent = "";
        adminSuccessP.textContent = "";
        const email = adminEmailInput.value.trim();
        const password = adminPasswordInput.value.trim();

        if (!email || !password) {
          adminErrorP.textContent = "Please enter email and password first.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();

          if (!res.ok) {
            adminErrorP.textContent = data.msg || "Failed to send OTP.";
            return;
          }

          adminOtpInput.disabled = false;
          adminOtpInput.focus();
          adminSuccessP.textContent = "OTP sent to your email.";
        } catch (err) {
          console.error("Admin OTP request error:", err);
          adminErrorP.textContent = "Server error while requesting OTP.";
        }
      });

      adminForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        adminErrorP.textContent = "";
        adminSuccessP.textContent = "";

        const email = adminEmailInput.value.trim();
        const otp = adminOtpInput.value.trim();

        if (adminOtpInput.disabled) {
          adminErrorP.textContent = "Please click 'Get OTP' first.";
          return;
        }

        if (!otp) {
          adminErrorP.textContent = "Please enter the OTP.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });
          const data = await res.json();

          if (!res.ok) {
            adminErrorP.textContent = data.msg || "OTP verification failed.";
            return;
          }

          if (data.role !== "admin") {
            adminErrorP.textContent = "Only admins can log in.";
            return;
          }

          localStorage.setItem("token", data.token);
          localStorage.setItem("name", data.name);
          localStorage.setItem("role", data.role);
          window.location.href = "dashboard.html";
        } catch (err) {
          console.error("Admin OTP verification error:", err);
          adminErrorP.textContent = "Server error during login.";
        }
      });

      // ==================== UNIFIED USER LOGIN ====================
      const userForm = document.getElementById("loginFormUser");
      const userGetOtpBtn = document.getElementById("userGetOtpBtn");
      const userOtpInput = document.getElementById("userOtp");
      const userEmailInput = document.getElementById("userEmail");
      const userPasswordInput = document.getElementById("userPassword");
      const userErrorP = document.getElementById("userError");
      const userSuccessP = document.getElementById("userSuccess");
      const changePasswordModal = document.getElementById("changePasswordModal");
      const changePasswordForm = document.getElementById("changePasswordForm");
      const changePasswordErrorP = document.getElementById("changePasswordError");

      userGetOtpBtn.addEventListener("click", async () => {
        userErrorP.textContent = "";
        userSuccessP.textContent = "";
        
        const userType = userTypeSelect.value;
        const email = userEmailInput.value.trim();
        const password = userPasswordInput.value.trim();

        if (!userType) {
          userErrorP.textContent = "Please select a user type first.";
          return;
        }

        if (!email || !password) {
          userErrorP.textContent = "Please enter email and password first.";
          return;
        }

        // Prepare login payload based on user type
        const loginData = { email, password };

        if (userType === "hr") {
          const hrIdNumber = hrIdNumberInput.value.trim();
          if (!hrIdNumber) {
            userErrorP.textContent = "Please enter HR ID Number.";
            return;
          }
          loginData.hrIdNumber = hrIdNumber;
        } else if (userType === "employee") {
          const badgeNumber = employeeBadgeNumberInput.value.trim();
          if (!badgeNumber) {
            userErrorP.textContent = "Please enter Badge Number.";
            return;
          }
          loginData.badgeNumber = badgeNumber;
        } else if (userType === "client") {
          const clientIdNumber = clientIdNumberInput.value.trim();
          if (!clientIdNumber) {
            userErrorP.textContent = "Please enter Client ID Number.";
            return;
          }
          loginData.clientIdNumber = clientIdNumber;
        }

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(loginData),
          });

          const data = await res.json();
          console.log("User login response:", data);

          if (!res.ok) {
            userErrorP.textContent = data.msg || "Failed to send OTP.";
            return;
          }

          userOtpInput.disabled = false;
          userOtpInput.value = "";
          userOtpInput.focus();
          userSuccessP.textContent = "OTP sent to your email.";
        } catch (err) {
          console.error("User OTP request error:", err);
          userErrorP.textContent = "Server error while requesting OTP.";
        }
      });

      userForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        userErrorP.textContent = "";
        userSuccessP.textContent = "";

        const userType = userTypeSelect.value;
        const email = userEmailInput.value.trim();
        const otp = userOtpInput.value.trim();

        if (!userType) {
          userErrorP.textContent = "Please select a user type.";
          return;
        }

        if (userOtpInput.disabled) {
          userErrorP.textContent = "Please click 'Get OTP' first.";
          return;
        }

        if (!otp) {
          userErrorP.textContent = "Please enter the OTP.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });

          const data = await res.json();
          console.log("User OTP verification response:", data);

          if (!res.ok) {
            userErrorP.textContent = data.msg || "OTP verification failed.";
            return;
          }

          // Verify user type matches
          if (data.role !== userType) {
            userErrorP.textContent = `Invalid credentials for ${userType} login.`;
            return;
          }

          // Store common data
          localStorage.setItem("token", data.token);
          localStorage.setItem("name", data.name);
          localStorage.setItem("role", data.role);

          // Handle based on user type
          if (userType === "employee") {
            localStorage.setItem("employeeId", data.employeeId || "N/A");

            if (data.requirePasswordChange) {
              changePasswordModal.classList.add("show");
              return;
            }

            window.location.href = "guardduty.html";
          } else if (userType === "hr") {
            window.location.href = "dashboard.html";
          } else if (userType === "client") {
            const userData = {
              _id: data._id,
              name: data.name,
              email: data.email,
              role: data.role,
              clientIdNumber: data.clientIdNumber,
              branch: data.branch,
              branchId: data.branchId,
              token: data.token
            };
            localStorage.setItem("user", JSON.stringify(userData));
            window.location.href = "client_portal.html";
          }
        } catch (err) {
          console.error("User OTP verification error:", err);
          userErrorP.textContent = "Server error during login.";
        }
      });

      // ===== Change Password on First Login =====
      changePasswordForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        changePasswordErrorP.textContent = "";
        const newPassword = document.getElementById("newPassword").value.trim();
        const confirmPassword = document.getElementById("confirmPassword").value.trim();

        if (!newPassword || !confirmPassword) {
          changePasswordErrorP.textContent = "Please fill in both password fields.";
          return;
        }

        if (newPassword !== confirmPassword) {
          changePasswordErrorP.textContent = "Passwords do not match!";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/change-password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ newPassword }),
          });

          const data = await res.json();
          if (!res.ok) {
            changePasswordErrorP.textContent = data.msg || "Failed to update password.";
            return;
          }

          changePasswordErrorP.textContent = "Password updated successfully!";
          setTimeout(() => {
            changePasswordModal.classList.remove("show");
            window.location.href = "guardduty.html";
          }, 1500);
        } catch (err) {
          console.error("Change password error:", err);
          changePasswordErrorP.textContent = "Server error while updating password.";
        }
      });

      // ===== EMPLOYEE REGISTRATION WITH 3-LAYER VALIDATION =====
      const registerModal = document.getElementById("registerModal");
      const closeRegister = document.getElementById("closeRegister");
      const userRegisterLink = document.getElementById("userRegisterLink");
      const registerForm = document.getElementById("registerForm");
      const badgeNoInput = document.getElementById("badgeNo");
      const familyNameInput = document.getElementById("familyName");
      const firstNameInput = document.getElementById("firstName");
      const middleNameInput = document.getElementById("middleName");
      const registerEmailInput = document.getElementById("registerEmail");
      const badgeNoFeedback = document.getElementById("badgeNoFeedback");
      const registerFormFeedback = document.getElementById("registerFormFeedback");
      const registerSubmitBtn = document.getElementById("registerSubmitBtn");

      // Badge number blur event - 3-LAYER VALIDATION
      badgeNoInput.addEventListener("blur", async () => {
        badgeNoFeedback.textContent = "";
        badgeNoFeedback.className = "feedback";
        registerFormFeedback.textContent = "";
        registerFormFeedback.className = "feedback";
        familyNameInput.value = "";
        firstNameInput.value = "";
        middleNameInput.value = "";
        registerSubmitBtn.disabled = true;

        const badgeNo = badgeNoInput.value.trim();

        if (!badgeNo) {
          badgeNoFeedback.textContent = "Please enter a badge number.";
          badgeNoFeedback.className = "feedback error";
          return;
        }

        try {
          console.log("üîç Starting 3-layer validation for badge number:", badgeNo);
          
          // LAYER 1: Check if badge number already exists in Register collection
          console.log("LAYER 1: Checking Register collection for duplicates...");
          const checkDuplicateRes = await fetch(
            `https://www.mither3security.com/api/registers?badgeNo=${encodeURIComponent(badgeNo)}`
          );
          const duplicateData = await checkDuplicateRes.json();

          if (checkDuplicateRes.ok && Array.isArray(duplicateData) && duplicateData.length > 0) {
            badgeNoFeedback.textContent = "‚ùå This SSS number is already registered. You cannot register again.";
            badgeNoFeedback.className = "feedback error";
            registerSubmitBtn.disabled = true;
            console.log("‚ùå LAYER 1 FAILED: Badge already registered");
            return;
          }
          console.log("‚úÖ LAYER 1 PASSED: Badge not in Register collection");

          // LAYER 2: Check if badge number exists in Archive collection
          console.log("LAYER 2: Checking Archive collection for employee records...");
          const archiveRes = await fetch(
            `https://www.mither3security.com/archive/search?badgeNo=${encodeURIComponent(badgeNo)}`
          );
          const archiveData = await archiveRes.json();

          console.log("Archive search response:", archiveData, "Status:", archiveRes.status);

          if (!archiveRes.ok || !archiveData || archiveData.length === 0) {
            badgeNoFeedback.textContent = "‚ùå SSS number not found in employee records. Cannot register.";
            badgeNoFeedback.className = "feedback error";
            registerSubmitBtn.disabled = true;
            console.log("‚ùå LAYER 2 FAILED: Badge not found in Archive");
            return;
          }
          console.log("‚úÖ LAYER 2 PASSED: Badge found in Archive");

          // LAYER 3: Badge found in Archive - auto-fill the fields
          console.log("LAYER 3: Badge validation successful, filling employee details...");
          const archive = Array.isArray(archiveData) ? archiveData[0] : archiveData;
          
          familyNameInput.value = archive.familyName || "";
          firstNameInput.value = archive.firstName || "";
          middleNameInput.value = archive.middleName || "";

          badgeNoFeedback.textContent = "‚úÖ SSS number verified! Fill in your email to complete registration.";
          badgeNoFeedback.className = "feedback success";
          registerSubmitBtn.disabled = false;
          registerEmailInput.focus();
          console.log("‚úÖ LAYER 3 PASSED: All validations successful");
        } catch (err) {
          console.error("Badge lookup error:", err);
          badgeNoFeedback.textContent = "‚ö†Ô∏è Error verifying badge number. Please try again.";
          badgeNoFeedback.className = "feedback error";
          registerSubmitBtn.disabled = true;
        }
      });

      // Email blur event - CHECK IF EMAIL EXISTS
      registerEmailInput.addEventListener("blur", async () => {
        const email = registerEmailInput.value.trim();

        if (!email) {
          registerFormFeedback.textContent = "";
          registerFormFeedback.className = "feedback";
          return;
        }

        try {
          console.log("üìß Checking if email already exists in Register collection...");
          
          const checkEmailRes = await fetch(
            `https://www.mither3security.com/api/registers?email=${encodeURIComponent(email)}`
          );
          const emailData = await checkEmailRes.json();

          if (checkEmailRes.ok && Array.isArray(emailData) && emailData.length > 0) {
            console.log("‚ùå EMAIL VALIDATION FAILED: Email already registered");
            registerFormFeedback.textContent = "‚ùå This email is already registered. Please use a different email.";
            registerFormFeedback.className = "feedback error";
            registerSubmitBtn.disabled = true;
            return;
          }

          console.log("‚úÖ EMAIL VALIDATION PASSED: Email not registered yet");
          registerFormFeedback.textContent = "‚úÖ Email is available.";
          registerFormFeedback.className = "feedback success";
          registerSubmitBtn.disabled = false;
        } catch (err) {
          console.error("Email validation error:", err);
          registerFormFeedback.textContent = "‚ö†Ô∏è Error validating email. Please try again.";
          registerFormFeedback.className = "feedback error";
        }
      });

      // Open register modal
      if (userRegisterLink) {
        userRegisterLink.addEventListener("click", (e) => {
          e.preventDefault();
          const userType = userTypeSelect.value;
          
          if (userType === "employee") {
            registerModal.classList.add("show");
            registerForm.reset();
            badgeNoInput.focus();
            badgeNoFeedback.textContent = "";
            badgeNoFeedback.className = "feedback";
            registerFormFeedback.textContent = "";
            registerFormFeedback.className = "feedback";
            registerSubmitBtn.disabled = true;
          } else if (userType === "client") {
            clientRegisterModal.classList.add("show");
          }
        });
      }

      // Close register modal
      if (closeRegister) {
        closeRegister.addEventListener("click", () => {
          registerModal.classList.remove("show");
        });
      }

      window.addEventListener("click", (e) => {
        if (e.target === registerModal) {
          registerModal.classList.remove("show");
        }
      });

      // Register form submission
      if (registerForm) {
        registerForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          registerFormFeedback.textContent = "";
          registerFormFeedback.className = "feedback";

          const familyName = familyNameInput.value.trim();
          const firstName = firstNameInput.value.trim();
          const middleName = middleNameInput.value.trim();
          const email = registerEmailInput.value.trim();
          const badgeNo = badgeNoInput.value.trim();

          if (!familyName || !firstName || !email || !badgeNo) {
            registerFormFeedback.textContent = "‚ùå Please fill in all required fields.";
            registerFormFeedback.className = "feedback error";
            return;
          }

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            registerFormFeedback.textContent = "‚ùå Please enter a valid email address.";
            registerFormFeedback.className = "feedback error";
            return;
          }

          const registrationData = { familyName, firstName, middleName, email, badgeNo };

          try {
            console.log("üì§ Submitting registration:", registrationData);
            
            const res = await fetch("https://www.mither3security.com/api/registers", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(registrationData),
            });

            const result = await res.json();
            console.log("Response status:", res.status);
            console.log("Response body:", result);

            if (!res.ok) {
              let errorMsg = result.msg || "Registration failed!";
              
              if (res.status === 409) {
                if (result.code === "BADGE_ALREADY_REGISTERED") {
                  errorMsg = "This SSS number is already registered.";
                } else if (result.code === "EMAIL_ALREADY_REGISTERED") {
                  errorMsg = "This email is already registered.";
                }
              } else if (res.status === 404) {
                if (result.code === "BADGE_NOT_IN_ARCHIVE") {
                  errorMsg = "SSS number not found in employee records.";
                }
              } else if (res.status === 400) {
                if (result.code === "NAME_MISMATCH") {
                  errorMsg = "The name provided does not match the employee record.";
                }
              }

              registerFormFeedback.textContent = "‚ùå " + errorMsg;
              registerFormFeedback.className = "feedback error";
              registerSubmitBtn.disabled = true;
              return;
            }

            registerFormFeedback.textContent = "‚úÖ Registration successful! Check your email for account activation details.";
            registerFormFeedback.className = "feedback success";
            registerForm.reset();
            registerSubmitBtn.disabled = true;
            
            setTimeout(() => {
              registerModal.classList.remove("show");
            }, 2000);
          } catch (err) {
            console.error("Register error:", err);
            registerFormFeedback.textContent = "‚ùå Server error during registration. Please try again.";
            registerFormFeedback.className = "feedback error";
          }
        });
      }

      // ==================== CLIENT REGISTRATION ====================
      const clientRegisterModal = document.getElementById("clientRegisterModal");
      const closeClientRegister = document.getElementById("closeClientRegister");
      const clientRegisterForm = document.getElementById("clientRegisterForm");
      const clientBranchSelect = document.getElementById("clientBranch");
      const clientRegisterErrorP = document.getElementById("clientRegisterError");
      const clientRegisterSuccessP = document.getElementById("clientRegisterSuccess");

      async function loadClientBranches() {
        try {
          const res = await fetch("https://www.mither3security.com/api/branches-management");
          const branches = await res.json();
          branches.forEach(branch => {
            const option = document.createElement("option");
            option.value = branch.name;
            option.textContent = branch.name;
            clientBranchSelect.appendChild(option);
          });
        } catch (err) {
          console.error("Failed to load branches:", err);
          clientRegisterErrorP.textContent = "Failed to load branch list. Please try again later.";
        }
      }

      loadClientBranches();

      if (closeClientRegister) {
        closeClientRegister.addEventListener("click", () => {
          clientRegisterModal.classList.remove("show");
        });
      }

      if (clientRegisterForm) {
        clientRegisterForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clientRegisterErrorP.textContent = "";
          clientRegisterSuccessP.textContent = "";

          const password = document.getElementById("clientPassword").value.trim();
          const passwordConfirm = document.getElementById("clientPasswordConfirm").value.trim();

          if (password !== passwordConfirm) {
            clientRegisterErrorP.textContent = "Passwords do not match. Please try again.";
            return;
          }

          const formData = new FormData();
          formData.append("name", document.getElementById("clientName").value.trim());
          formData.append("email", document.getElementById("clientEmail").value.trim());
          formData.append("password", password);
          formData.append("branch", clientBranchSelect.value);
          formData.append("role", "client");
          formData.append("status", "Pending");

          const contractFile = document.getElementById("contractFile").files[0];
          if (contractFile) {
            formData.append("contract", contractFile);
          }

          try {
            const res = await fetch("https://www.mither3security.com/accounts", {
              method: "POST",
              body: formData
            });

            const result = await res.json();

            if (!res.ok) {
              clientRegisterErrorP.textContent = result.msg || "Failed to create client request";
              return;
            }

            clientRegisterSuccessP.textContent = "Client request submitted. Waiting for admin approval.";
            clientRegisterForm.reset();
            
            setTimeout(() => {
              clientRegisterModal.classList.remove("show");
            }, 2000);
          } catch (err) {
            console.error("Error creating client:", err);
            clientRegisterErrorP.textContent = "Server error: " + err.message;
          }
        });
      }
    });
  </script>
</body>
</html>