<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login Selection</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    :root {
      --clr-light: #f5f7fa;
      --clr-primary: #131315;
      --clr-white: #ffffff;
      --clr-dark: #222222;
      --clr-color-dark: #2e2e2e;
      --clr-color-background: #f0f2f5;
      --clr-black-variant: #555555;
      --clr-info-dark: #7d8da1;
      --clr-success: #1abc9c;
      --clr-danger: #e74c3c;
      --clr-warning: #f39c12;
      --card-padding: 0.8rem;
      --card-border-radius: 12px;
      --card-box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(26, 188, 156, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(52, 152, 219, 0.15) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: "";
      position: fixed;
      bottom: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(19, 19, 21, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(30px, -30px); }
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(19, 19, 21, 0.7);
      backdrop-filter: blur(10px);
      color: var(--clr-white);
      padding: 1.2rem 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 100;
    }

    .left-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .logo:hover {
      border-color: var(--clr-success);
      transform: scale(1.05);
    }

    .system-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--clr-white);
      letter-spacing: 1px;
    }

    .login-btn {
      background: linear-gradient(135deg, var(--clr-primary) 0%, var(--clr-color-dark) 100%);
      color: var(--clr-white);
      border: none;
      padding: 0.7rem 1.8rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(19, 19, 21, 0.3);
      position: relative;
      z-index: 2;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(19, 19, 21, 0.4);
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
    }

    .modal.show {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(135deg, var(--clr-white) 0%, #f8f9fa 100%);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 3rem 2.5rem;
      width: 100%;
      max-width: 450px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      animation: slideUp 0.4s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-content h2 {
      color: var(--clr-primary);
      font-size: 1.8rem;
      font-weight: 700;
      text-align: left;
      margin-bottom: 2rem;
      position: relative;
      padding-bottom: 1rem;
    }

    .modal-content h2::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 4px;
      background: linear-gradient(90deg, var(--clr-primary) 0%, var(--clr-success) 100%);
      border-radius: 2px;
    }

    .close {
      position: absolute;
      right: 1.5rem;
      top: 1.5rem;
      font-size: 1.8rem;
      color: var(--clr-info-dark);
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }

    .close:hover {
      color: var(--clr-danger);
      background: rgba(231, 76, 60, 0.1);
      transform: scale(1.1);
    }

    .role-buttons {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      margin-top: 0.5rem;
    }

    .role-btn {
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 12px;
      color: var(--clr-white);
      background: linear-gradient(135deg, var(--clr-primary) 0%, var(--clr-color-dark) 100%);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(19, 19, 21, 0.2);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
    }

    .role-btn:hover {
      background: linear-gradient(135deg, var(--clr-color-dark) 0%, var(--clr-primary) 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(19, 19, 21, 0.3);
    }

    .role-btn span {
      font-size: 1.2rem;
    }

    /* Login Form Styles */
    .login-form {
      display: none;
    }

    .login-form.show {
      display: block;
    }

    .role-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .role-header button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--clr-info-dark);
      transition: all 0.3s ease;
    }

    .role-header button:hover {
      color: var(--clr-primary);
      transform: scale(1.1);
    }

    .role-header h3 {
      color: var(--clr-primary);
      font-size: 1.2rem;
      margin: 0;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    input {
      padding: 0.9rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--clr-primary);
      box-shadow: 0 0 0 3px rgba(19, 19, 21, 0.1);
    }

    input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    .otp-row {
      display: flex;
      gap: 0.8rem;
    }

    .otp-row input {
      flex: 1;
    }

    button[type="submit"],
    button[type="button"] {
      padding: 0.9rem 1.5rem;
      background: linear-gradient(135deg, var(--clr-primary) 0%, var(--clr-color-dark) 100%);
      color: var(--clr-white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(19, 19, 21, 0.2);
    }

    button[type="submit"]:hover,
    button[type="button"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(19, 19, 21, 0.3);
    }

    .otp-row button[type="button"] {
      flex: 0 1 120px;
    }

    .error {
      color: var(--clr-danger);
      font-size: 0.9rem;
      text-align: center;
    }

    .success {
      color: var(--clr-success);
      font-size: 0.9rem;
      text-align: center;
    }

    .register-text {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--clr-black-variant);
    }

    .register-link {
      color: var(--clr-primary);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .register-link:hover {
      color: var(--clr-success);
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .top-bar {
        padding: 1rem 1.5rem;
      }

      .system-name {
        font-size: 1.2rem;
      }

      .modal-content {
        width: 90%;
        padding: 2rem 1.5rem;
      }

      .modal-content h2 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .role-btn {
        padding: 0.9rem 1.2rem;
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <header class="top-bar">
    <div class="left-section">
      <img src="../../image/logo.png" alt="Logo" class="logo" />
      <h1 class="system-name">MITHER3</h1>
    </div>
    <button class="login-btn" id="loginBtn">Log In</button>
  </header>

  <div class="modal" id="loginModal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>

      <!-- Role Selection View -->
      <div id="roleSelection">
        <h2>Log in</h2>
        <div class="role-buttons">
          <button class="role-btn" data-role="admin">
            <span class="material-symbols-outlined">admin_panel_settings</span>
            Admin Log In
          </button>
          <button class="role-btn" data-role="hr">
            <span class="material-symbols-outlined">people_alt</span>
            HR Log In
          </button>
          <button class="role-btn" data-role="employee">
            <span class="material-symbols-outlined">person</span>
            Employee Log In
          </button>
          <button class="role-btn" data-role="client">
            <span class="material-symbols-outlined">business</span>
            Client Log In
          </button>
        </div>
      </div>

      <!-- Admin Login Form -->
      <div id="adminForm" class="login-form">
        <div class="role-header">
          <button type="button" id="backBtn">←</button>
          <h3>Admin Login</h3>
        </div>
        <form id="loginFormAdmin">
          <input type="email" id="adminEmail" placeholder="Email" required>
          <input type="password" id="adminPassword" placeholder="Password" required>
          <div class="otp-row">
            <input type="text" id="adminOtp" placeholder="Enter OTP" disabled required>
            <button type="button" id="adminGetOtpBtn">Get OTP</button>
          </div>
          <button type="submit">Login</button>
        </form>
        <p id="adminError" class="error"></p>
        <p id="adminSuccess" class="success"></p>
      </div>

      <!-- HR Login Form -->
      <div id="hrForm" class="login-form">
        <div class="role-header">
          <button type="button" class="backBtn">←</button>
          <h3>HR Login</h3>
        </div>
        <form id="loginFormHR">
          <input type="email" id="hrEmail" placeholder="Email" required>
          <input type="text" id="hrIdNumber" placeholder="ID Number" required>
          <input type="password" id="hrPassword" placeholder="Password" required>
          <div class="otp-row">
            <input type="text" id="hrOtp" placeholder="Enter OTP" disabled required>
            <button type="button" id="hrGetOtpBtn">Get OTP</button>
          </div>
          <button type="submit">Login</button>
        </form>
        <p id="hrError" class="error"></p>
        <p id="hrSuccess" class="success"></p>
      </div>

      <!-- Employee Login Form -->
      <div id="employeeForm" class="login-form">
        <div class="role-header">
          <button type="button" class="backBtn">←</button>
          <h3>Employee Login</h3>
        </div>
        <form id="loginFormEmployee">
          <input type="email" id="employeeEmail" placeholder="Email" required>
          <input type="text" id="employeeBadgeNumber" placeholder="SSS NR (00-0000000-0)" required maxlength="12">
          <input type="password" id="employeePassword" placeholder="Password" required>
          <div class="otp-row">
            <input type="text" id="employeeOtp" placeholder="Enter OTP" disabled required>
            <button type="button" id="employeeGetOtpBtn">Get OTP</button>
          </div>
          <button type="submit">Login</button>
        </form>
        <p id="employeeError" class="error"></p>
        <p id="employeeSuccess" class="success"></p>
        <p class="register-text" style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">
          No account? <span id="employeeRegisterLink" class="register-link" style="color: var(--clr-primary); cursor: pointer; font-weight: 600;">Register here</span>
        </p>
      </div>

      <!-- Client Login Form -->
      <div id="clientForm" class="login-form">
        <div class="role-header">
          <button type="button" class="backBtn">←</button>
          <h3>Client Login</h3>
        </div>
        <form id="loginFormClient">
          <input type="email" id="clientLoginEmail" placeholder="Email" required>
          <input type="text" id="clientIdNumber" placeholder="ID Number" required>
          <input type="password" id="clientLoginPassword" placeholder="Password" required>
          <div class="otp-row">
            <input type="text" id="clientOtp" placeholder="Enter OTP" disabled required>
            <button type="button" id="clientGetOtpBtn">Get OTP</button>
          </div>
          <button type="submit">Login</button>
        </form>
        <p id="clientError" class="error"></p>
        <p id="clientSuccess" class="success"></p>
        <p class="register-text" style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">
          No account? <span id="clientRegisterLink" class="register-link" style="color: var(--clr-primary); cursor: pointer; font-weight: 600;">Register here</span>
        </p>
      </div>
    </div>
  </div>

  <!-- Register Modal for Employee -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <span class="close" id="closeRegister">&times;</span>
      <h2>Employee Registration</h2>

      <form id="registerForm">
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <input type="text" id="familyName" placeholder="Family Name" required>
          <input type="text" id="firstName" placeholder="First Name" required>
          <input type="text" id="middleName" placeholder="Middle Name">
          <input type="email" id="registerEmail" placeholder="Email" required>
          <input type="text" id="badgeNo" placeholder="SSS NR (00-0000000-0)" required maxlength="12">
        </div>
        <button type="submit" style="margin-top: 1rem;">Register</button>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal" id="changePasswordModal">
    <div class="modal-content">
      <h2>Change Password</h2>
      <form id="changePasswordForm">
        <input type="password" id="newPassword" placeholder="New Password" required />
        <input type="password" id="confirmPassword" placeholder="Confirm Password" required />
        <button type="submit">Update Password</button>
      </form>
      <p id="changePasswordError" class="error"></p>
    </div>
  </div>

  <!-- Client Registration Modal -->
  <div class="modal" id="clientRegisterModal">
    <div class="modal-content" style="max-width: 500px;">
      <span class="close" id="closeClientRegister">&times;</span>
      <h2>Register as a Client</h2>

      <form id="clientRegisterForm" enctype="multipart/form-data">
        <input type="text" id="clientName" placeholder="Name" required />
        <input type="email" id="clientEmail" placeholder="Email" required />
        <input type="password" id="clientPassword" placeholder="Password" required />
        <input type="password" id="clientPasswordConfirm" placeholder="Confirm Password" required />
        
        <select id="clientBranch" required>
          <option value="">Select a branch</option>
        </select>

        <label style="font-size: 0.9rem; color: var(--clr-info-dark); margin-top: 0.5rem; display: block;">
          Contract (PDF, DOC, DOCX):
        </label>
        <input type="file" id="contractFile" accept=".pdf,.doc,.docx" required />

        <button type="submit">Submit Registration</button>
      </form>
      <p id="clientRegisterError" class="error"></p>
      <p id="clientRegisterSuccess" class="success"></p>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:5000/api/users";

    document.addEventListener("DOMContentLoaded", () => {
      const loginBtn = document.getElementById("loginBtn");
      const modal = document.getElementById("loginModal");
      const closeModal = document.getElementById("closeModal");
      const roleSelection = document.getElementById("roleSelection");
      const roleButtons = document.querySelectorAll(".role-btn");
      const backBtn = document.getElementById("backBtn");
      const backBtns = document.querySelectorAll(".backBtn");

      // Open modal
      loginBtn.addEventListener("click", () => {
        modal.classList.add("show");
        showRoleSelection();
      });

      // Close modal
      closeModal.addEventListener("click", () => {
        modal.classList.remove("show");
      });

      window.addEventListener("click", (e) => {
        if (e.target === modal) modal.classList.remove("show");
      });

      // Show role selection
      function showRoleSelection() {
        document.querySelectorAll(".login-form").forEach(f => f.classList.remove("show"));
        roleSelection.style.display = "block";
      }

      // Show form for role
      function showForm(role) {
        roleSelection.style.display = "none";
        document.querySelectorAll(".login-form").forEach(f => f.classList.remove("show"));
        const formId = `${role}Form`;
        document.getElementById(formId).classList.add("show");
      }

      // Role button listeners
      roleButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const role = btn.dataset.role;
          showForm(role);
        });
      });

      // Back button listeners
      backBtn.addEventListener("click", showRoleSelection);
      backBtns.forEach(btn => {
        btn.addEventListener("click", showRoleSelection);
      });

      // ==================== ADMIN LOGIN ====================
      const adminForm = document.getElementById("loginFormAdmin");
      const adminGetOtpBtn = document.getElementById("adminGetOtpBtn");
      const adminOtpInput = document.getElementById("adminOtp");
      const adminEmailInput = document.getElementById("adminEmail");
      const adminPasswordInput = document.getElementById("adminPassword");
      const adminErrorP = document.getElementById("adminError");
      const adminSuccessP = document.getElementById("adminSuccess");

      adminGetOtpBtn.addEventListener("click", async () => {
        adminErrorP.textContent = "";
        adminSuccessP.textContent = "";
        const email = adminEmailInput.value.trim();
        const password = adminPasswordInput.value.trim();

        if (!email || !password) {
          adminErrorP.textContent = "Please enter email and password first.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();

          if (!res.ok) {
            adminErrorP.textContent = data.msg || "Failed to send OTP.";
            return;
          }

          adminOtpInput.disabled = false;
          adminOtpInput.focus();
          adminSuccessP.textContent = "OTP sent to your email.";
        } catch (err) {
          console.error("Admin OTP request error:", err);
          adminErrorP.textContent = "Server error while requesting OTP.";
        }
      });

      adminForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        adminErrorP.textContent = "";
        adminSuccessP.textContent = "";

        const email = adminEmailInput.value.trim();
        const otp = adminOtpInput.value.trim();

        if (adminOtpInput.disabled) {
          adminErrorP.textContent = "Please click 'Get OTP' first.";
          return;
        }

        if (!otp) {
          adminErrorP.textContent = "Please enter the OTP.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });
          const data = await res.json();

          if (!res.ok) {
            adminErrorP.textContent = data.msg || "OTP verification failed.";
            return;
          }

          if (data.role !== "admin") {
            adminErrorP.textContent = "Only admins can log in.";
            return;
          }

          localStorage.setItem("token", data.token);
          localStorage.setItem("name", data.name);
          localStorage.setItem("role", data.role);
          window.location.href = "dashboard.html";
        } catch (err) {
          console.error("Admin OTP verification error:", err);
          adminErrorP.textContent = "Server error during login.";
        }
      });

      // ==================== HR LOGIN ====================
      const hrForm = document.getElementById("loginFormHR");
      const hrGetOtpBtn = document.getElementById("hrGetOtpBtn");
      const hrOtpInput = document.getElementById("hrOtp");
      const hrEmailInput = document.getElementById("hrEmail");
      const hrIdNumberInput = document.getElementById("hrIdNumber");
      const hrPasswordInput = document.getElementById("hrPassword");
      const hrErrorP = document.getElementById("hrError");
      const hrSuccessP = document.getElementById("hrSuccess");

      hrGetOtpBtn.addEventListener("click", async () => {
        hrErrorP.textContent = "";
        hrSuccessP.textContent = "";
        const email = hrEmailInput.value.trim();
        const hrIdNumber = hrIdNumberInput.value.trim();
        const password = hrPasswordInput.value.trim();

        if (!email || !hrIdNumber || !password) {
          hrErrorP.textContent = "Please fill Email, ID Number, and Password first.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, hrIdNumber }),
          });

          const data = await res.json();
          console.log("HR login response:", data);

          if (!res.ok) {
            hrErrorP.textContent = data.msg || "Failed to send OTP.";
            return;
          }

          hrOtpInput.disabled = false;
          hrOtpInput.value = "";
          hrOtpInput.focus();
          hrSuccessP.textContent = "OTP sent to your email.";
        } catch (err) {
          console.error("HR OTP request error:", err);
          hrErrorP.textContent = "Server error while requesting OTP.";
        }
      });

      hrForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        hrErrorP.textContent = "";
        hrSuccessP.textContent = "";

        const email = hrEmailInput.value.trim();
        const otp = hrOtpInput.value.trim();

        if (hrOtpInput.disabled) {
          hrErrorP.textContent = "Please click 'Get OTP' first.";
          return;
        }

        if (!otp) {
          hrErrorP.textContent = "Please enter the OTP.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });

          const data = await res.json();
          console.log("HR OTP verification response:", data);

          if (!res.ok) {
            hrErrorP.textContent = data.msg || "OTP verification failed.";
            return;
          }

          if (data.role !== "hr") {
            hrErrorP.textContent = "Only HR personnel can log in.";
            return;
          }

          localStorage.setItem("token", data.token);
          localStorage.setItem("role", data.role);
          localStorage.setItem("name", data.name);

          window.location.href = "dashboard.html";
        } catch (err) {
          console.error("HR OTP verification error:", err);
          hrErrorP.textContent = "Server error during login.";
        }
      });

      // ==================== EMPLOYEE LOGIN ====================
      const employeeForm = document.getElementById("loginFormEmployee");
      const employeeGetOtpBtn = document.getElementById("employeeGetOtpBtn");
      const employeeOtpInput = document.getElementById("employeeOtp");
      const employeeEmailInput = document.getElementById("employeeEmail");
      const employeeBadgeNumberInput = document.getElementById("employeeBadgeNumber");
      const employeePasswordInput = document.getElementById("employeePassword");
      const employeeErrorP = document.getElementById("employeeError");
      const employeeSuccessP = document.getElementById("employeeSuccess");
      const changePasswordModal = document.getElementById("changePasswordModal");
      const changePasswordForm = document.getElementById("changePasswordForm");
      const changePasswordErrorP = document.getElementById("changePasswordError");

      // Badge number formatting
      [employeeBadgeNumberInput, document.getElementById("badgeNo")].forEach(input => {
        if (input) {
          input.addEventListener("input", function() {
            this.value = this.value
              .replace(/[^0-9]/g, "")
              .replace(/(\d{2})(\d{1,7})(\d{0,1}).*/, function(_, p1, p2, p3) {
                return p3 ? `${p1}-${p2}-${p3}` : p2 ? `${p1}-${p2}` : p1;
              });
          });
        }
      });

      employeeGetOtpBtn.addEventListener("click", async () => {
        employeeErrorP.textContent = "";
        employeeSuccessP.textContent = "";
        const email = employeeEmailInput.value.trim();
        const badgeNumber = employeeBadgeNumberInput.value.trim();
        const password = employeePasswordInput.value.trim();

        if (!email || !badgeNumber || !password) {
          employeeErrorP.textContent = "Please fill Email, Badge Number, and Password first.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, badgeNumber }),
          });

          const data = await res.json();
          console.log("Employee login response:", data);

          if (!res.ok) {
            employeeErrorP.textContent = data.msg || "Failed to send OTP.";
            return;
          }

          employeeOtpInput.disabled = false;
          employeeOtpInput.value = "";
          employeeOtpInput.focus();
          employeeSuccessP.textContent = "OTP sent to your email.";
        } catch (err) {
          console.error("Employee OTP request error:", err);
          employeeErrorP.textContent = "Server error while requesting OTP.";
        }
      });

      employeeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        employeeErrorP.textContent = "";
        employeeSuccessP.textContent = "";

        const email = employeeEmailInput.value.trim();
        const otp = employeeOtpInput.value.trim();

        if (employeeOtpInput.disabled) {
          employeeErrorP.textContent = "Please click 'Get OTP' first.";
          return;
        }

        if (!otp) {
          employeeErrorP.textContent = "Please enter the OTP.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });

          const data = await res.json();
          console.log("Employee OTP verification response:", data);

          if (!res.ok) {
            employeeErrorP.textContent = data.msg || "OTP verification failed.";
            return;
          }

          // Store data locally
          localStorage.setItem("token", data.token);
          localStorage.setItem("name", data.name);
          localStorage.setItem("role", data.role);
          localStorage.setItem("employeeId", data.employeeId || "N/A");

          // Check if password change required
          if (data.requirePasswordChange) {
            changePasswordModal.classList.add("show");
            return;
          }

          window.location.href = "guardduty.html";
        } catch (err) {
          console.error("Employee OTP verification error:", err);
          employeeErrorP.textContent = "Server error during login.";
        }
      });

      // ===== Change Password on First Login =====
      changePasswordForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        changePasswordErrorP.textContent = "";
        const newPassword = document.getElementById("newPassword").value.trim();
        const confirmPassword = document.getElementById("confirmPassword").value.trim();

        if (!newPassword || !confirmPassword) {
          changePasswordErrorP.textContent = "Please fill in both password fields.";
          return;
        }

        if (newPassword !== confirmPassword) {
          changePasswordErrorP.textContent = "Passwords do not match!";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/change-password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ newPassword }),
          });

          const data = await res.json();
          if (!res.ok) {
            changePasswordErrorP.textContent = data.msg || "Failed to update password.";
            return;
          }

          changePasswordErrorP.textContent = "Password updated successfully!";
          setTimeout(() => {
            changePasswordModal.classList.remove("show");
            window.location.href = "guardduty.html";
          }, 1500);
        } catch (err) {
          console.error("Change password error:", err);
          changePasswordErrorP.textContent = "Server error while updating password.";
        }
      });

      // ===== Employee Registration =====
      const registerModal = document.getElementById("registerModal");
      const closeRegister = document.getElementById("closeRegister");
      const employeeRegisterLink = document.getElementById("employeeRegisterLink");
      const registerForm = document.getElementById("registerForm");

      if (employeeRegisterLink) {
        employeeRegisterLink.addEventListener("click", (e) => {
          e.preventDefault();
          registerModal.classList.add("show");
        });
      }

      if (closeRegister) {
        closeRegister.addEventListener("click", () => {
          registerModal.classList.remove("show");
        });
      }

      window.addEventListener("click", (e) => {
        if (e.target === registerModal) {
          registerModal.classList.remove("show");
        }
        if (e.target === changePasswordModal) {
          changePasswordModal.classList.remove("show");
        }
      });

      if (registerForm) {
        registerForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const familyName = document.getElementById("familyName").value.trim();
          const firstName = document.getElementById("firstName").value.trim();
          const middleName = document.getElementById("middleName").value.trim();
          const email = document.getElementById("registerEmail").value.trim();
          const badgeNo = document.getElementById("badgeNo").value.trim();

          if (!familyName || !firstName || !email || !badgeNo) {
            alert("Please fill in all required fields.");
            return;
          }

          const data = { familyName, firstName, middleName, email, badgeNo };

          try {
            const res = await fetch("http://localhost:5000/api/registers", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });

            console.log("Response status:", res.status);
            const result = await res.json();
            console.log("Response body:", result);

            if (!res.ok) {
              alert(result.msg || "Registration failed!");
              return;
            }

            alert("Registration successful!");
            registerModal.classList.remove("show");
            registerForm.reset();
          } catch (err) {
            console.error("Register error:", err);
            alert("Server error during registration.");
          }
        });
      }

      // ==================== CLIENT LOGIN ====================
      const clientForm = document.getElementById("loginFormClient");
      const clientGetOtpBtn = document.getElementById("clientGetOtpBtn");
      const clientOtpInput = document.getElementById("clientOtp");
      const clientLoginEmailInput = document.getElementById("clientLoginEmail");
      const clientIdNumberInput = document.getElementById("clientIdNumber");
      const clientLoginPasswordInput = document.getElementById("clientLoginPassword");
      const clientErrorP = document.getElementById("clientError");
      const clientSuccessP = document.getElementById("clientSuccess");

      clientGetOtpBtn.addEventListener("click", async () => {
        clientErrorP.textContent = "";
        clientSuccessP.textContent = "";
        const email = clientLoginEmailInput.value.trim();
        const clientIdNumber = clientIdNumberInput.value.trim();
        const password = clientLoginPasswordInput.value.trim();

        if (!email || !clientIdNumber || !password) {
          clientErrorP.textContent = "Please fill Email, ID Number, and Password first.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, clientIdNumber }),
          });

          const data = await res.json();
          console.log("Client login response:", data);

          if (!res.ok) {
            clientErrorP.textContent = data.msg || "Failed to send OTP.";
            return;
          }

          clientOtpInput.disabled = false;
          clientOtpInput.value = "";
          clientOtpInput.focus();
          clientSuccessP.textContent = "OTP sent to your email.";
        } catch (err) {
          console.error("Client OTP request error:", err);
          clientErrorP.textContent = "Server error while requesting OTP.";
        }
      });

      clientForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        clientErrorP.textContent = "";
        clientSuccessP.textContent = "";

        const email = clientLoginEmailInput.value.trim();
        const otp = clientOtpInput.value.trim();

        if (clientOtpInput.disabled) {
          clientErrorP.textContent = "Please click 'Get OTP' first.";
          return;
        }

        if (!otp) {
          clientErrorP.textContent = "Please enter the OTP.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });

          const data = await res.json();
          console.log("Client OTP verification response:", data);

          if (!res.ok) {
            clientErrorP.textContent = data.msg || "OTP verification failed.";
            return;
          }

          // Save full client info + token in localStorage
          const userData = {
            _id: data._id,
            name: data.name,
            email: data.email,
            role: data.role,
            clientIdNumber: data.clientIdNumber,
            branch: data.branch,
            branchId: data.branchId,
            token: data.token
          };

          localStorage.setItem("user", JSON.stringify(userData));
          window.location.href = "client_portal.html";
        } catch (err) {
          console.error("Client OTP verification error:", err);
          clientErrorP.textContent = "Server error during login.";
        }
      });

      // ==================== CLIENT REGISTRATION ====================
      const clientRegisterModal = document.getElementById("clientRegisterModal");
      const closeClientRegister = document.getElementById("closeClientRegister");
      const clientRegisterLink = document.getElementById("clientRegisterLink");
      const clientRegisterForm = document.getElementById("clientRegisterForm");
      const clientBranchSelect = document.getElementById("clientBranch");
      const clientRegisterErrorP = document.getElementById("clientRegisterError");
      const clientRegisterSuccessP = document.getElementById("clientRegisterSuccess");

      // Load branches
      async function loadClientBranches() {
        try {
          const res = await fetch("http://localhost:5000/api/branches-management");
          const branches = await res.json();
          branches.forEach(branch => {
            const option = document.createElement("option");
            option.value = branch.name;
            option.textContent = branch.name;
            clientBranchSelect.appendChild(option);
          });
        } catch (err) {
          console.error("Failed to load branches:", err);
          clientRegisterErrorP.textContent = "Failed to load branch list. Please try again later.";
        }
      }

      loadClientBranches();

      if (clientRegisterLink) {
        clientRegisterLink.addEventListener("click", (e) => {
          e.preventDefault();
          clientRegisterModal.classList.add("show");
        });
      }

      if (closeClientRegister) {
        closeClientRegister.addEventListener("click", () => {
          clientRegisterModal.classList.remove("show");
        });
      }

      if (clientRegisterForm) {
        clientRegisterForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clientRegisterErrorP.textContent = "";
          clientRegisterSuccessP.textContent = "";

          const password = document.getElementById("clientPassword").value.trim();
          const passwordConfirm = document.getElementById("clientPasswordConfirm").value.trim();

          if (password !== passwordConfirm) {
            clientRegisterErrorP.textContent = "Passwords do not match. Please try again.";
            return;
          }

          const formData = new FormData();
          formData.append("name", document.getElementById("clientName").value.trim());
          formData.append("email", document.getElementById("clientEmail").value.trim());
          formData.append("password", password);
          formData.append("branch", clientBranchSelect.value);
          formData.append("role", "client");
          formData.append("status", "Pending");

          const contractFile = document.getElementById("contractFile").files[0];
          if (contractFile) {
            formData.append("contract", contractFile);
          }

          try {
            const res = await fetch("http://localhost:5000/accounts", {
              method: "POST",
              body: formData
            });

            const result = await res.json();

            if (!res.ok) {
              clientRegisterErrorP.textContent = result.msg || "Failed to create client request";
              return;
            }

            clientRegisterSuccessP.textContent = "Client request submitted. Waiting for admin approval.";
            clientRegisterForm.reset();
            
            setTimeout(() => {
              clientRegisterModal.classList.remove("show");
            }, 2000);
          } catch (err) {
            console.error("Error creating client:", err);
            clientRegisterErrorP.textContent = "Server error: " + err.message;
          }
        });
      }
    });
  </script>
</body>
</html>