<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login Selection</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    :root {
      --clr-light: #f5f7fa;
      --clr-primary: #131315;
      --clr-white: #ffffff;
      --clr-dark: #222222;
      --clr-color-dark: #2e2e2e;
      --clr-color-background: #f0f2f5;
      --clr-black-variant: #555555;
      --clr-info-dark: #7d8da1;
      --clr-success: #1abc9c;
      --clr-danger: #e74c3c;
      --clr-warning: #f39c12;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
      background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(22, 33, 62, 0.9) 50%, rgba(15, 52, 96, 0.9) 100%),
                  url('../image/login-background.jpeg') center/cover no-repeat fixed;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(26, 188, 156, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(52, 152, 219, 0.15) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: "";
      position: fixed;
      bottom: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(19, 19, 21, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(30px, -30px); }
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(19, 19, 21, 0.7);
      backdrop-filter: blur(10px);
      color: var(--clr-white);
      padding: 1.2rem 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 100;
    }

    .left-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      object-fit: cover;
      border: 2px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .logo:hover {
      border-color: var(--clr-success);
      transform: scale(1.05);
    }

    .system-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--clr-white);
      letter-spacing: 1px;
    }

    .login-btn {
      background: linear-gradient(135deg, var(--clr-primary) 0%, var(--clr-color-dark) 100%);
      color: var(--clr-white);
      border: none;
      padding: 0.7rem 1.8rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(19, 19, 21, 0.3);
      position: relative;
      z-index: 2;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(19, 19, 21, 0.4);
    }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease;
      overflow-y: auto;
    }

    .modal.show {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(135deg, var(--clr-white) 0%, #f8f9fa 100%);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 3rem 2.5rem;
      width: 100%;
      max-width: 450px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      animation: slideUp 0.4s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin: auto;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-content h2 {
      color: var(--clr-primary);
      font-size: 1.8rem;
      font-weight: 700;
      text-align: left;
      margin-bottom: 2rem;
      position: relative;
      padding-bottom: 1rem;
    }

    .modal-content h2::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50px;
      height: 4px;
      background: linear-gradient(90deg, var(--clr-primary) 0%, var(--clr-success) 100%);
      border-radius: 2px;
    }

    .close {
      position: absolute;
      right: 1.5rem;
      top: 1.5rem;
      font-size: 1.8rem;
      color: var(--clr-info-dark);
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }

    .close:hover {
      color: var(--clr-danger);
      background: rgba(231, 76, 60, 0.1);
      transform: scale(1.1);
    }

    .role-buttons {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      margin-top: 0.5rem;
    }

    .role-btn {
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 12px;
      color: var(--clr-white);
      background: linear-gradient(135deg, var(--clr-primary) 0%, var(--clr-color-dark) 100%);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(19, 19, 21, 0.2);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
    }

    .role-btn:hover {
      background: linear-gradient(135deg, var(--clr-color-dark) 0%, var(--clr-primary) 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(19, 19, 21, 0.3);
    }

    .role-btn span {
      font-size: 1.2rem;
    }

    .login-form {
      display: none;
    }

    .login-form.show {
      display: block;
    }

    .role-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .role-header button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--clr-info-dark);
      transition: all 0.3s ease;
    }

    .role-header button:hover {
      color: var(--clr-primary);
      transform: scale(1.1);
    }

    .role-header h3 {
      color: var(--clr-primary);
      font-size: 1.2rem;
      margin: 0;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    input, select {
      padding: 0.9rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--clr-primary);
      box-shadow: 0 0 0 3px rgba(19, 19, 21, 0.1);
    }

    input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
      color: #999;
    }

    input[readonly] {
      background: #f5f5f5;
      cursor: not-allowed;
      color: var(--clr-primary);
    }

    .otp-row {
      display: flex;
      gap: 0.8rem;
    }

    .otp-row input {
      flex: 1;
    }

    button[type="submit"],
    button[type="button"] {
      padding: 0.9rem 1.5rem;
      background: linear-gradient(135deg, var(--clr-primary) 0%, var(--clr-color-dark) 100%);
      color: var(--clr-white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(19, 19, 21, 0.2);
    }

    button[type="submit"]:hover:not(:disabled),
    button[type="button"]:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(19, 19, 21, 0.3);
    }

    button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .otp-row button[type="button"] {
      flex: 0 1 120px;
    }

    .error {
      color: var(--clr-danger);
      font-size: 0.9rem;
      text-align: center;
      margin: 0 !important;
    }

    .success {
      color: var(--clr-success);
      font-size: 0.9rem;
      text-align: center;
      margin: 0 !important;
    }

    .register-text {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--clr-black-variant);
    }

    .register-link {
      color: var(--clr-primary);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .register-link:hover {
      color: var(--clr-success);
      text-decoration: underline;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 600;
      color: var(--clr-primary);
      font-size: 0.95rem;
    }

    .form-group label .required {
      color: var(--clr-danger);
      margin-left: 0.2rem;
    }

    .form-group input, .form-group select {
      padding: 0.85rem 0.95rem;
      font-size: 0.95rem;
    }

    .form-group .feedback {
      font-size: 0.85rem;
      margin-top: 0.2rem;
      min-height: 1.2rem;
    }

    .form-group .feedback.error {
      color: var(--clr-danger);
    }

    .form-group .feedback.success {
      color: var(--clr-success);
    }

    .dynamic-input {
      display: none;
    }

    .dynamic-input.show {
      display: block;
    }

    .face-section {
      background: rgba(26, 188, 156, 0.1);
      border: 2px dashed var(--clr-success);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.2rem 0;
      text-align: center;
    }

    .face-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
      margin-bottom: 1rem;
    }

    .face-header .material-symbols-outlined {
      font-size: 2rem;
      color: var(--clr-success);
    }

    .face-header div {
      text-align: left;
    }

    .face-header-title {
      font-weight: 600;
      color: var(--clr-primary);
      font-size: 0.95rem;
    }

    .face-header-subtitle {
      font-size: 0.85rem;
      color: #666;
    }

    .face-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
      margin-top: 1rem;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .face-status.verified {
      color: var(--clr-success);
    }

    .face-status.pending {
      color: var(--clr-warning);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.success {
      background: var(--clr-success);
      animation: pulse 2s infinite;
    }

    .status-dot.warning {
      background: var(--clr-warning);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 1.2rem;
    }

    .button-group button {
      flex: 1;
    }

    .secondary-btn {
      background: linear-gradient(135deg, #7d8da1 0%, #5a6b7d 100%);
    }

    .secondary-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #5a6b7d 0%, #3d4a5c 100%);
    }

    .message {
      padding: 0.8rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      display: none;
      text-align: center;
    }

    .message.show {
      display: block;
    }

    .message.error {
      background: rgba(231, 76, 60, 0.1);
      color: var(--clr-danger);
      border: 1px solid var(--clr-danger);
    }

    .message.success {
      background: rgba(26, 188, 156, 0.1);
      color: var(--clr-success);
      border: 1px solid var(--clr-success);
    }

    .message.info {
      background: rgba(52, 152, 219, 0.1);
      color: #3498db;
      border: 1px solid #3498db;
    }

    @media (max-width: 600px) {
      .top-bar { padding: 1rem 1.5rem; }
      .system-name { font-size: 1.2rem; }
      .modal-content { width: 90%; padding: 2rem 1.5rem; }
      .modal-content h2 { font-size: 1.5rem; margin-bottom: 1.5rem; }
      .role-btn { padding: 0.9rem 1.2rem; font-size: 0.95rem; }
      .button-group { flex-direction: column; }
      .face-header { flex-direction: column; gap: 0.5rem; }
      .face-header div { text-align: center; }
    }
  </style>
</head>
<body>
  <header class="top-bar">
    <div class="left-section">
      <img src="../../image/logo.png" alt="Logo" class="logo" />
      <h1 class="system-name">MITHER3</h1>
    </div>
    <button class="login-btn" id="loginBtn">Log In</button>
  </header>

  <div class="modal" id="loginModal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>

      <div id="roleSelection">
        <h2>Log in</h2>
        <div class="role-buttons">
          <button class="role-btn" data-role="admin">
            <span class="material-symbols-outlined">admin_panel_settings</span>
            Admin Log In
          </button>
          <button class="role-btn" data-role="user">
            <span class="material-symbols-outlined">person</span>
            Login as User
          </button>
        </div>
      </div>

      <div id="adminForm" class="login-form">
        <div class="role-header">
          <button type="button" id="backBtn">‚Üê</button>
          <h3>Admin Login</h3>
        </div>
        <form id="loginFormAdmin">
          <input type="email" id="adminEmail" placeholder="Email" required>
          <input type="password" id="adminPassword" placeholder="Password" required>
          <div class="otp-row">
            <input type="text" id="adminOtp" placeholder="Enter OTP" disabled required>
            <button type="button" id="adminGetOtpBtn">Get OTP</button>
          </div>
          <button type="submit">Login</button>
        </form>
        <p id="adminError" class="error"></p>
        <p id="adminSuccess" class="success"></p>
      </div>

      <div id="userForm" class="login-form">
        <div class="role-header">
          <button type="button" class="backBtn">‚Üê</button>
          <h3>User Login</h3>
        </div>
        <form id="loginFormUser">
          <select id="userTypeSelect" required>
            <option value="">Select User Type</option>
            <option value="hr">HR</option>
            <option value="employee">Employee</option>
            <option value="client">Client</option>
          </select>

          <input type="email" id="userEmail" placeholder="Email" required>
          <input type="text" id="hrIdNumber" class="dynamic-input" placeholder="HR ID Number" required>
          <input type="text" id="employeeBadgeNumber" class="dynamic-input" placeholder="SSS NR (00-0000000-0)" required maxlength="12">
          <input type="text" id="clientIdNumber" class="dynamic-input" placeholder="Client ID Number" required>
          <input type="password" id="userPassword" placeholder="Password" required>
          <div class="otp-row">
            <input type="text" id="userOtp" placeholder="Enter OTP" disabled required>
            <button type="button" id="userGetOtpBtn">Get OTP</button>
          </div>
          <button type="submit">Login</button>
        </form>
        <p id="userError" class="error"></p>
        <p id="userSuccess" class="success"></p>
        <p class="register-text" id="registerTextContainer" style="display:none;">
          No account? <span id="userRegisterLink" class="register-link">Register here</span>
        </p>
      </div>
    </div>
  </div>

  <div class="modal" id="registerModal">
    <div class="modal-content">
      <span class="close" id="closeRegister">&times;</span>
      <h2>Employee Registration</h2>

      <div id="registrationMessage" class="message"></div>

      <form id="registerForm">
        <div class="form-group">
          <label for="badgeNo">SSS NR (00-0000000-0) <span class="required">*</span></label>
          <input type="text" id="badgeNo" placeholder="Enter SSS NR (00-0000000-0)" required maxlength="12">
          <div id="badgeNoFeedback" class="feedback"></div>
        </div>

        <div class="form-group">
          <label for="familyName">Family Name <span class="required">*</span></label>
          <input type="text" id="familyName" placeholder="Family Name" readonly>
        </div>

        <div class="form-group">
          <label for="firstName">First Name <span class="required">*</span></label>
          <input type="text" id="firstName" placeholder="First Name" readonly>
        </div>

        <div class="form-group">
          <label for="middleName">Middle Name</label>
          <input type="text" id="middleName" placeholder="Middle Name" readonly>
        </div>

        <div class="form-group">
          <label for="registerEmail">Email <span class="required">*</span></label>
          <input type="email" id="registerEmail" placeholder="Enter your email" required>
          <div id="emailFeedback" class="feedback"></div>
        </div>

        <div class="face-section">
          <div class="face-header">
            <span class="material-symbols-outlined">face</span>
            <div>
              <div class="face-header-title">Face Recognition</div>
              <div class="face-header-subtitle">Secure biometric enrollment</div>
            </div>
          </div>
          <button type="button" id="enrollFaceBtn" class="secondary-btn">Enroll Face</button>
          <div id="faceStatus" class="face-status pending" style="display: none;">
            <span class="status-dot warning"></span>
            <span id="faceStatusText">Pending face enrollment</span>
          </div>
        </div>

        <div class="button-group">
          <button type="button" id="cancelRegisterBtn" class="secondary-btn">Cancel</button>
          <button type="submit" id="registerSubmitBtn" disabled>Complete Registration</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="changePasswordModal">
    <div class="modal-content">
      <h2>Change Password</h2>
      <form id="changePasswordForm">
        <input type="password" id="newPassword" placeholder="New Password" required />
        <input type="password" id="confirmPassword" placeholder="Confirm Password" required />
        <button type="submit">Update Password</button>
      </form>
      <p id="changePasswordError" class="error"></p>
      <p id="changePasswordSuccess" class="success"></p>
    </div>
  </div>

  <div class="modal" id="clientRegisterModal">
    <div class="modal-content" style="max-width: 500px;">
      <span class="close" id="closeClientRegister">&times;</span>
      <h2>Register as a Client</h2>

      <form id="clientRegisterForm" enctype="multipart/form-data">
        <input type="text" id="clientName" placeholder="Name" required />
        <input type="email" id="clientEmail" placeholder="Email" required />
        <input type="password" id="clientPassword" placeholder="Password" required />
        <input type="password" id="clientPasswordConfirm" placeholder="Confirm Password" required />
        <select id="clientBranch" required>
          <option value="">Select a branch</option>
        </select>

        <label style="font-size: 0.9rem; color: var(--clr-info-dark); margin-top: 0.5rem; display: block;">
          Contract (PDF):
        </label>
        <input type="file" id="contractFile" accept=".pdf" required />
        <button type="submit">Submit Registration</button>
      </form>
      <p id="clientRegisterError" class="error"></p>
      <p id="clientRegisterSuccess" class="success"></p>
    </div>
  </div>

  <script>
    // ===== GLOBAL VARIABLES =====
    const API_URL = "https://www.mither3security.com/api/users";
    const REGISTERS_API_URL = "https://www.mither3security.com/api/registers";
    const ARCHIVE_API_URL = "https://www.mither3security.com/archive/search";
    
    let faceDescriptor = null;
    let videoStream = null;
    let isCameraActive = false;
    let modelsLoaded = false;

    // ===== LOAD FACE API AND MODELS =====
    async function initFaceAPI() {
      const cdns = [
        'https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js',
        'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js',
        'https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js'
      ];

      for (let cdn of cdns) {
        try {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = cdn;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
          
          if (typeof faceapi !== 'undefined') {
            console.log('‚úÖ face-api loaded from:', cdn);
            await loadFaceAPIModels();
            return;
          }
        } catch (err) {
          console.warn('Failed to load from:', cdn, err);
        }
      }
      
      console.error('‚ùå Could not load face-api from any CDN');
    }

    async function loadFaceAPIModels() {
      const modelUrl = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
      
      try {
        console.log('üì¶ Loading face-api models...');
        
        await Promise.all([
          faceapi.nets.ssdMobilenetv1.loadFromUri(modelUrl),
          faceapi.nets.faceLandmark68Net.loadFromUri(modelUrl),
          faceapi.nets.faceRecognitionNet.loadFromUri(modelUrl),
          faceapi.nets.faceExpressionNet.loadFromUri(modelUrl)
        ]);
        
        modelsLoaded = true;
        console.log('‚úÖ All models loaded successfully!');
        return true;
      } catch (err) {
        console.error('‚ùå Failed to load models:', err);
        return false;
      }
    }

    // Initialize face-api on page load
    window.addEventListener('load', initFaceAPI);

    // ===== HELPER FUNCTIONS =====
    function showRegistrationMessage(message, type = 'info') {
      const box = document.getElementById('registrationMessage');
      box.textContent = message;
      box.className = `message show ${type}`;
      if (type !== 'error') setTimeout(() => box.classList.remove('show'), 3000);
    }

    function validatePassword(password) {
      return /[A-Z]/.test(password) && /[0-9]/.test(password) && password.length >= 8;
    }

    function getPasswordErrors(password) {
      const errors = [];
      if (password.length < 8) errors.push("At least 8 characters");
      if (!/[A-Z]/.test(password)) errors.push("At least 1 capital letter");
      if (!/[0-9]/.test(password)) errors.push("At least 1 number");
      return errors;
    }

    function formatSSS(value) {
      return value.replace(/[^0-9]/g, "").replace(/(\d{2})(\d{1,7})(\d{0,1}).*/, (_, p1, p2, p3) => p3 ? `${p1}-${p2}-${p3}` : p2 ? `${p1}-${p2}` : p1);
    }

    // ===== FACE API FUNCTIONS =====
    async function startCamera() {
      try {
        const video = document.createElement('video');
        video.id = 'faceVideo';
        video.width = 320;
        video.height = 240;
        video.autoplay = true;
        
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { width: 320, height: 240, facingMode: 'user' }
        });
        
        video.srcObject = videoStream;
        isCameraActive = true;
        
        await new Promise(resolve => {
          video.onloadedmetadata = () => {
            video.play();
            resolve();
          };
        });
        
        console.log('‚úÖ Camera started');
        return video;
      } catch (err) {
        console.error('‚ùå Camera error:', err);
        showRegistrationMessage('Camera access denied or unavailable', 'error');
        return null;
      }
    }

    async function captureAndDetectFace(video) {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        console.log('üîç Detecting face...');
        
        const detection = await faceapi
          .detectSingleFace(canvas)
          .withFaceLandmarks()
          .withFaceDescriptor();

        if (!detection) {
          return {
            success: false,
            error: 'No face detected. Please position your face in the camera.',
          };
        }

        if (detection.detection.score < 0.7) {
          return {
            success: false,
            error: 'Face confidence too low. Please ensure good lighting.',
          };
        }

        const imageBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

        console.log('‚úÖ Face detected successfully');

        return {
          success: true,
          descriptor: detection.descriptor,
          imageBase64,
        };
      } catch (err) {
        console.error('‚ùå Face detection error:', err);
        return {
          success: false,
          error: `Face detection failed: ${err.message}`,
        };
      }
    }

    function stopCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        isCameraActive = false;
      }
    }

    // ===== MAIN DOM CONTENT LOADED =====
    document.addEventListener("DOMContentLoaded", () => {
      // Get DOM elements
      const loginBtn = document.getElementById("loginBtn");
      const modal = document.getElementById("loginModal");
      const closeModal = document.getElementById("closeModal");
      const roleSelection = document.getElementById("roleSelection");
      const roleButtons = document.querySelectorAll(".role-btn");
      const backBtn = document.getElementById("backBtn");
      const backBtns = document.querySelectorAll(".backBtn");

      const userTypeSelect = document.getElementById("userTypeSelect");
      const hrIdNumberInput = document.getElementById("hrIdNumber");
      const employeeBadgeNumberInput = document.getElementById("employeeBadgeNumber");
      const clientIdNumberInput = document.getElementById("clientIdNumber");
      const registerTextContainer = document.getElementById("registerTextContainer");

      const adminForm = document.getElementById("loginFormAdmin");
      const adminGetOtpBtn = document.getElementById("adminGetOtpBtn");
      const adminOtpInput = document.getElementById("adminOtp");
      const adminEmailInput = document.getElementById("adminEmail");
      const adminPasswordInput = document.getElementById("adminPassword");
      const adminErrorP = document.getElementById("adminError");
      const adminSuccessP = document.getElementById("adminSuccess");

      const userForm = document.getElementById("loginFormUser");
      const userGetOtpBtn = document.getElementById("userGetOtpBtn");
      const userOtpInput = document.getElementById("userOtp");
      const userEmailInput = document.getElementById("userEmail");
      const userPasswordInput = document.getElementById("userPassword");
      const userErrorP = document.getElementById("userError");
      const userSuccessP = document.getElementById("userSuccess");

      const changePasswordModal = document.getElementById("changePasswordModal");
      const changePasswordForm = document.getElementById("changePasswordForm");
      const changePasswordErrorP = document.getElementById("changePasswordError");
      const changePasswordSuccessP = document.getElementById("changePasswordSuccess");

      const registerModal = document.getElementById("registerModal");
      const closeRegister = document.getElementById("closeRegister");
      const userRegisterLink = document.getElementById("userRegisterLink");
      const registerForm = document.getElementById("registerForm");
      const badgeNoInput = document.getElementById("badgeNo");
      const familyNameInput = document.getElementById("familyName");
      const firstNameInput = document.getElementById("firstName");
      const middleNameInput = document.getElementById("middleName");
      const registerEmailInput = document.getElementById("registerEmail");
      const badgeNoFeedback = document.getElementById("badgeNoFeedback");
      const emailFeedback = document.getElementById("emailFeedback");
      const registerSubmitBtn = document.getElementById("registerSubmitBtn");
      const enrollFaceBtn = document.getElementById("enrollFaceBtn");
      const cancelRegisterBtn = document.getElementById("cancelRegisterBtn");
      const faceStatus = document.getElementById("faceStatus");
      const faceStatusText = document.getElementById("faceStatusText");

      const clientRegisterModal = document.getElementById("clientRegisterModal");
      const closeClientRegister = document.getElementById("closeClientRegister");
      const clientRegisterForm = document.getElementById("clientRegisterForm");
      const clientBranchSelect = document.getElementById("clientBranch");
      const clientRegisterErrorP = document.getElementById("clientRegisterError");
      const clientRegisterSuccessP = document.getElementById("clientRegisterSuccess");

      // ===== MODAL & NAVIGATION =====
      loginBtn.addEventListener("click", () => {
        modal.classList.add("show");
        roleSelection.style.display = "block";
        document.querySelectorAll(".login-form").forEach(f => f.classList.remove("show"));
      });

      closeModal.addEventListener("click", () => modal.classList.remove("show"));
      window.addEventListener("click", (e) => {
        if (e.target === modal) modal.classList.remove("show");
      });

      roleButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          roleSelection.style.display = "none";
          document.querySelectorAll(".login-form").forEach(f => f.classList.remove("show"));
          document.getElementById(`${btn.dataset.role}Form`).classList.add("show");
        });
      });

      backBtn.addEventListener("click", () => {
        roleSelection.style.display = "block";
        document.querySelectorAll(".login-form").forEach(f => f.classList.remove("show"));
      });

      backBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          roleSelection.style.display = "block";
          document.querySelectorAll(".login-form").forEach(f => f.classList.remove("show"));
        });
      });

      // ===== USER TYPE SELECTION =====
      userTypeSelect.addEventListener("change", (e) => {
        const userType = e.target.value;
        [hrIdNumberInput, employeeBadgeNumberInput, clientIdNumberInput].forEach(el => {
          el.classList.remove("show");
          el.removeAttribute("required");
        });
        registerTextContainer.style.display = "none";

        if (userType === "hr") {
          hrIdNumberInput.classList.add("show");
          hrIdNumberInput.setAttribute("required", "required");
        } else if (userType === "employee") {
          employeeBadgeNumberInput.classList.add("show");
          employeeBadgeNumberInput.setAttribute("required", "required");
          registerTextContainer.style.display = "block";
        } else if (userType === "client") {
          clientIdNumberInput.classList.add("show");
          clientIdNumberInput.setAttribute("required", "required");
          registerTextContainer.style.display = "block";
        }
      });

      [employeeBadgeNumberInput, badgeNoInput].forEach(input => {
        if (input) {
          input.addEventListener("input", function() {
            this.value = formatSSS(this.value);
          });
        }
      });

      // ===== ADMIN LOGIN =====
      adminGetOtpBtn.addEventListener("click", async () => {
        adminErrorP.textContent = "";
        adminSuccessP.textContent = "";
        const email = adminEmailInput.value.trim();
        const password = adminPasswordInput.value.trim();

        if (!email || !password) {
          adminErrorP.textContent = "Please enter email and password first.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });
          const data = await res.json();

          if (!res.ok) {
            adminErrorP.textContent = data.msg || "Failed to send OTP.";
            return;
          }

          adminOtpInput.disabled = false;
          adminOtpInput.focus();
          adminSuccessP.textContent = "OTP sent to your email.";
        } catch (err) {
          console.error("Admin OTP error:", err);
          adminErrorP.textContent = "Server error while requesting OTP.";
        }
      });

      adminForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        adminErrorP.textContent = "";
        adminSuccessP.textContent = "";

        const email = adminEmailInput.value.trim();
        const otp = adminOtpInput.value.trim();

        if (adminOtpInput.disabled) {
          adminErrorP.textContent = "Please click 'Get OTP' first.";
          return;
        }

        if (!otp) {
          adminErrorP.textContent = "Please enter the OTP.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });
          const data = await res.json();

          if (!res.ok) {
            adminErrorP.textContent = data.msg || "OTP verification failed.";
            return;
          }

          if (data.role !== "admin") {
            adminErrorP.textContent = "Only admins can log in.";
            return;
          }

          localStorage.setItem("token", data.token);
          localStorage.setItem("name", data.name);
          localStorage.setItem("role", data.role);
          window.location.href = "dashboard.html";
        } catch (err) {
          console.error("Admin verification error:", err);
          adminErrorP.textContent = "Server error during login.";
        }
      });

      // ===== USER LOGIN - UPDATED TO INCLUDE BADGE NO IN TOKEN =====
      userGetOtpBtn.addEventListener("click", async () => {
        userErrorP.textContent = "";
        userSuccessP.textContent = "";
        
        const userType = userTypeSelect.value;
        const email = userEmailInput.value.trim();
        const password = userPasswordInput.value.trim();

        if (!userType) {
          userErrorP.textContent = "Please select a user type first.";
          return;
        }

        if (!email || !password) {
          userErrorP.textContent = "Please enter email and password first.";
          return;
        }

        const loginData = { email, password };

        if (userType === "hr") {
          const hrIdNumber = hrIdNumberInput.value.trim();
          if (!hrIdNumber) {
            userErrorP.textContent = "Please enter HR ID Number.";
            return;
          }
          loginData.hrIdNumber = hrIdNumber;
        } else if (userType === "employee") {
          const badgeNumber = employeeBadgeNumberInput.value.trim();
          if (!badgeNumber) {
            userErrorP.textContent = "Please enter Badge Number.";
            return;
          }
          loginData.badgeNumber = badgeNumber;
        } else if (userType === "client") {
          const clientIdNumber = clientIdNumberInput.value.trim();
          if (!clientIdNumber) {
            userErrorP.textContent = "Please enter Client ID Number.";
            return;
          }
          loginData.clientIdNumber = clientIdNumber;
        }

        try {
          const res = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(loginData),
          });

          const data = await res.json();

          if (!res.ok) {
            userErrorP.textContent = data.msg || "Failed to send OTP.";
            return;
          }

          userOtpInput.disabled = false;
          userOtpInput.value = "";
          userOtpInput.focus();
          userSuccessP.textContent = "OTP sent to your email.";
        } catch (err) {
          console.error("User OTP error:", err);
          userErrorP.textContent = "Server error while requesting OTP.";
        }
      });

      userForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        userErrorP.textContent = "";
        userSuccessP.textContent = "";

        const userType = userTypeSelect.value;
        const email = userEmailInput.value.trim();
        const otp = userOtpInput.value.trim();

        if (!userType) {
          userErrorP.textContent = "Please select a user type.";
          return;
        }

        if (userOtpInput.disabled) {
          userErrorP.textContent = "Please click 'Get OTP' first.";
          return;
        }

        if (!otp) {
          userErrorP.textContent = "Please enter the OTP.";
          return;
        }

        try {
          const res = await fetch(`${API_URL}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });

          const data = await res.json();

          if (!res.ok) {
            userErrorP.textContent = data.msg || "OTP verification failed.";
            return;
          }

          if (data.role !== userType) {
            userErrorP.textContent = `Invalid credentials for ${userType} login.`;
            return;
          }

          localStorage.setItem("token", data.token);
          localStorage.setItem("name", data.name);
          localStorage.setItem("role", data.role);

          if (userType === "employee") {
            // ‚úÖ UPDATED: Store badgeNo from response for time-in operations
            localStorage.setItem("employeeId", data.employeeId || "N/A");
            localStorage.setItem("badgeNo", data.badgeNo || data.badgeNumber || "N/A");
            
            console.log("‚úÖ Employee login successful");
            console.log("üîê Stored Values:");
            console.log("  - Token:", localStorage.getItem("token") ? "‚úì" : "‚úó");
            console.log("  - Employee ID:", localStorage.getItem("employeeId"));
            console.log("  - Badge No:", localStorage.getItem("badgeNo"));
            
            if (data.requirePasswordChange) {
              changePasswordModal.classList.add("show");
              return;
            }
            window.location.href = "guardduty.html";
          } else if (userType === "hr") {
            window.location.href = "dashboard.html";
          } else if (userType === "client") {
            const userData = {
              _id: data._id,
              name: data.name,
              email: data.email,
              role: data.role,
              clientIdNumber: data.clientIdNumber,
              branch: data.branch,
              branchId: data.branchId,
              token: data.token
            };
            localStorage.setItem("user", JSON.stringify(userData));
            window.location.href = "client_portal.html";
          }
        } catch (err) {
          console.error("User verification error:", err);
          userErrorP.textContent = "Server error during login.";
        }
      });

      // ===== CHANGE PASSWORD =====
      changePasswordForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        changePasswordErrorP.textContent = "";
        changePasswordSuccessP.textContent = "";
        const newPassword = document.getElementById("newPassword").value.trim();
        const confirmPassword = document.getElementById("confirmPassword").value.trim();

        if (!newPassword || !confirmPassword) {
          changePasswordErrorP.textContent = "Please fill in both password fields.";
          return;
        }

        if (newPassword !== confirmPassword) {
          changePasswordErrorP.textContent = "Passwords do not match!";
          return;
        }

        const errors = getPasswordErrors(newPassword);
        if (errors.length > 0) {
          changePasswordErrorP.textContent = "Password requirements: " + errors.join(", ");
          return;
        }

        try {
          const res = await fetch(`${API_URL}/change-password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ newPassword }),
          });

          const data = await res.json();
          if (!res.ok) {
            changePasswordErrorP.textContent = data.msg || "Failed to update password.";
            return;
          }

          changePasswordSuccessP.textContent = "Password updated successfully!";
          setTimeout(() => {
            changePasswordModal.classList.remove("show");
            window.location.href = "guardduty.html";
          }, 1500);
        } catch (err) {
          console.error("Change password error:", err);
          changePasswordErrorP.textContent = "Server error while updating password.";
        }
      });

      // ===== EMPLOYEE REGISTRATION =====
      badgeNoInput.addEventListener("blur", async () => {
        badgeNoFeedback.textContent = "";
        badgeNoFeedback.className = "feedback";
        familyNameInput.value = "";
        firstNameInput.value = "";
        middleNameInput.value = "";
        registerSubmitBtn.disabled = true;

        const badgeNo = badgeNoInput.value.trim();

        if (!badgeNo) {
          badgeNoFeedback.textContent = "Please enter a badge number.";
          badgeNoFeedback.className = "feedback error";
          return;
        }

        try {
          const checkDuplicateRes = await fetch(`${REGISTERS_API_URL}?badgeNo=${encodeURIComponent(badgeNo)}`);
          const duplicateData = await checkDuplicateRes.json();

          if (checkDuplicateRes.ok && Array.isArray(duplicateData) && duplicateData.length > 0) {
            badgeNoFeedback.textContent = "‚ùå This SSS number is already registered.";
            badgeNoFeedback.className = "feedback error";
            return;
          }

          const archiveRes = await fetch(`${ARCHIVE_API_URL}?badgeNo=${encodeURIComponent(badgeNo)}`);
          const archiveData = await archiveRes.json();

          if (!archiveRes.ok || !archiveData || archiveData.length === 0) {
            badgeNoFeedback.textContent = "‚ùå SSS number not found in employee records.";
            badgeNoFeedback.className = "feedback error";
            return;
          }

          const archive = Array.isArray(archiveData) ? archiveData[0] : archiveData;
          familyNameInput.value = archive.familyName || "";
          firstNameInput.value = archive.firstName || "";
          middleNameInput.value = archive.middleName || "";

          badgeNoFeedback.textContent = "‚úÖ SSS number verified! Fill in your email to continue.";
          badgeNoFeedback.className = "feedback success";
          registerSubmitBtn.disabled = false;
          registerEmailInput.focus();
        } catch (err) {
          console.error("Badge lookup error:", err);
          badgeNoFeedback.textContent = "‚ö†Ô∏è Error verifying badge number.";
          badgeNoFeedback.className = "feedback error";
        }
      });

      registerEmailInput.addEventListener("blur", async () => {
        const email = registerEmailInput.value.trim();
        emailFeedback.textContent = "";
        emailFeedback.className = "feedback";

        if (!email) return;

        try {
          const checkEmailRes = await fetch(`${REGISTERS_API_URL}?email=${encodeURIComponent(email)}`);
          const emailData = await checkEmailRes.json();

          if (checkEmailRes.ok && Array.isArray(emailData) && emailData.length > 0) {
            emailFeedback.textContent = "‚ùå This email is already registered.";
            emailFeedback.className = "feedback error";
            registerSubmitBtn.disabled = true;
            return;
          }

          emailFeedback.textContent = "‚úÖ Email is available.";
          emailFeedback.className = "feedback success";
          if (badgeNoInput.value.trim()) registerSubmitBtn.disabled = false;
        } catch (err) {
          console.error("Email validation error:", err);
        }
      });

      // ===== ENROLL FACE BUTTON =====
      enrollFaceBtn.addEventListener("click", async (e) => {
        e.preventDefault();

        if (!modelsLoaded) {
          showRegistrationMessage('‚è≥ Face detection models are still loading. Please wait...', 'info');
          const loaded = await loadFaceAPIModels();
          if (!loaded) {
            showRegistrationMessage('‚ùå Failed to load face detection models. Please refresh the page.', 'error');
            enrollFaceBtn.disabled = false;
            return;
          }
        }

        try {
          enrollFaceBtn.disabled = true;
          showRegistrationMessage("üì∑ Starting face capture. Look at your camera.", "info");

          const video = await startCamera();
          if (!video) {
            enrollFaceBtn.disabled = false;
            return;
          }

          await new Promise(r => setTimeout(r, 2000));

          const captureResult = await captureAndDetectFace(video);
          stopCamera();

          if (!captureResult.success) {
            showRegistrationMessage(captureResult.error, 'error');
            faceStatus.style.display = 'flex';
            faceStatus.className = 'face-status pending';
            faceStatusText.textContent = '‚ùå ' + captureResult.error;
            enrollFaceBtn.disabled = false;
            return;
          }

          faceDescriptor = captureResult;

          faceStatus.style.display = 'flex';
          faceStatus.className = 'face-status verified';
          faceStatusText.textContent = '‚úÖ Face captured successfully!';

          showRegistrationMessage('‚úÖ Face enrollment complete! You can now submit your registration.', 'success');
          registerSubmitBtn.disabled = false;
          enrollFaceBtn.textContent = 'Retake Photo';

        } catch (err) {
          console.error('Face enrollment error:', err);
          stopCamera();
          showRegistrationMessage(`Face enrollment failed: ${err.message}`, 'error');
          enrollFaceBtn.disabled = false;
        }
      });

      // ===== REGISTER FORM SUBMIT =====
      registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!faceDescriptor) {
          showRegistrationMessage("Please enroll your face first.", "error");
          return;
        }

        const familyName = familyNameInput.value.trim();
        const firstName = firstNameInput.value.trim();
        const middleName = middleNameInput.value.trim();
        const email = registerEmailInput.value.trim();
        const badgeNo = badgeNoInput.value.trim();

        if (!familyName || !firstName || !email || !badgeNo) {
          showRegistrationMessage("Please fill in all required fields.", "error");
          return;
        }

        try {
          registerSubmitBtn.disabled = true;
          showRegistrationMessage("üì§ Submitting registration with face data...", "info");

          const registrationData = {
            familyName,
            firstName,
            middleName,
            email,
            badgeNo,
            faceImageBase64: faceDescriptor.imageBase64,
          };

          const res = await fetch(REGISTERS_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(registrationData),
          });

          const result = await res.json();

          if (!res.ok) {
            showRegistrationMessage(result.msg || "Registration failed!", "error");
            registerSubmitBtn.disabled = false;
            return;
          }

          showRegistrationMessage("‚úÖ Registration successful! Check your email for activation details.", "success");

          setTimeout(() => {
            registerModal.classList.remove("show");
            registerForm.reset();
            faceDescriptor = null;
            faceStatus.style.display = "none";
            enrollFaceBtn.textContent = "Enroll Face";
          }, 2000);
        } catch (err) {
          console.error("Registration error:", err);
          showRegistrationMessage("Server error during registration. Please try again.", "error");
          registerSubmitBtn.disabled = false;
        }
      });

      // ===== CANCEL REGISTRATION =====
      cancelRegisterBtn.addEventListener("click", (e) => {
        e.preventDefault();
        stopCamera();
        registerForm.reset();
        faceDescriptor = null;
        faceStatus.style.display = "none";
        registerSubmitBtn.disabled = true;
        enrollFaceBtn.textContent = "Enroll Face";
        registerModal.classList.remove("show");
      });

      // ===== CLOSE REGISTER MODAL =====
      if (closeRegister) {
        closeRegister.addEventListener("click", () => {
          stopCamera();
          registerModal.classList.remove("show");
          registerForm.reset();
          faceDescriptor = null;
          faceStatus.style.display = "none";
          enrollFaceBtn.textContent = "Enroll Face";
        });
      }

      // ===== REGISTER LINK =====
      if (userRegisterLink) {
        userRegisterLink.addEventListener("click", (e) => {
          e.preventDefault();
          const userType = userTypeSelect.value;

          if (userType === "employee") {
            registerModal.classList.add("show");
            registerForm.reset();
            faceDescriptor = null;
            faceStatus.style.display = "none";
            enrollFaceBtn.textContent = "Enroll Face";
            badgeNoInput.focus();
          } else if (userType === "client") {
            clientRegisterModal.classList.add("show");
          }
        });
      }

      // ===== WINDOW CLICK OUTSIDE MODAL =====
      window.addEventListener("click", (e) => {
        if (e.target === registerModal) {
          stopCamera();
          registerModal.classList.remove("show");
          registerForm.reset();
          faceDescriptor = null;
          faceStatus.style.display = "none";
          enrollFaceBtn.textContent = "Enroll Face";
        }
      });

      // ===== CLIENT REGISTRATION =====
      async function loadClientBranches() {
        try {
          const res = await fetch("https://www.mither3security.com/api/branches-management");
          const branches = await res.json();
          branches.forEach(branch => {
            const option = document.createElement("option");
            option.value = branch.name;
            option.textContent = branch.name;
            clientBranchSelect.appendChild(option);
          });
        } catch (err) {
          console.error("Failed to load branches:", err);
          clientRegisterErrorP.textContent = "Failed to load branch list.";
        }
      }

      loadClientBranches();

      if (closeClientRegister) {
        closeClientRegister.addEventListener("click", () => {
          clientRegisterModal.classList.remove("show");
        });
      }

      if (clientRegisterForm) {
        clientRegisterForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          clientRegisterErrorP.textContent = "";
          clientRegisterSuccessP.textContent = "";

          const password = document.getElementById("clientPassword").value.trim();
          const passwordConfirm = document.getElementById("clientPasswordConfirm").value.trim();

          if (password !== passwordConfirm) {
            clientRegisterErrorP.textContent = "Passwords do not match.";
            return;
          }

          const formData = new FormData();
          formData.append("name", document.getElementById("clientName").value.trim());
          formData.append("email", document.getElementById("clientEmail").value.trim());
          formData.append("password", password);
          formData.append("branch", clientBranchSelect.value);
          formData.append("role", "client");
          formData.append("status", "Pending");

          const contractFile = document.getElementById("contractFile").files[0];
          if (contractFile) {
            formData.append("contract", contractFile);
          }

          try {
            const res = await fetch("https://www.mither3security.com/accounts", {
              method: "POST",
              body: formData
            });

            const result = await res.json();

            if (!res.ok) {
              clientRegisterErrorP.textContent = result.msg || "Failed to create client request";
              return;
            }

            clientRegisterSuccessP.textContent = "Client request submitted. Waiting for admin approval.";
            clientRegisterForm.reset();

            setTimeout(() => {
              clientRegisterModal.classList.remove("show");
            }, 2000);
          } catch (err) {
            console.error("Client registration error:", err);
            clientRegisterErrorP.textContent = "Server error: " + err.message;
          }
        });
      }
    });
  </script>
</body>
</html>